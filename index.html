<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>소상공인 종합지원을 위한 자가진단 (Real AI)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100;300;400;500;700;900&display=swap');

        body {
            font-family: 'Noto Sans KR', sans-serif;
        }

        .print-only {
            display: none;
        }

        /* 화면용 AI 텍스트 헤더 스타일 */
        .ai-text-header {
            font-size: 1.1rem;
            font-weight: 900;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            color: #1e293b;
            border-bottom: 1px dashed #cbd5e1;
            padding-bottom: 0.25rem;
        }

        /* [중요] 통합버전18의 인쇄 설정 100% 원복 (입력 페이지 인쇄 보존용) */
        @media print {
            @page {
                size: A4;
                margin: 0;
            }

            /* [NEW] 리포트 전용 페이지 설정 (매 페이지 동일한 상단 여백 확보) */
            @page report-fmt {
                size: A4;
                margin: 20mm 10mm 10mm 10mm;
                /* 상단 20mm, 하좌우 10mm */
            }

            .no-print {
                display: none !important;
            }

            .print-only {
                display: inline !important;
            }

            .screen-only {
                display: none !important;
            }

            body {
                padding: 0 !important;
                background: white !important;
                font-size: 8.5pt !important;
                line-height: 1.15 !important;
                display: flex !important;
                flex-direction: column !important;
                justify-content: center !important;
                align-items: center !important;
                width: 210mm !important;
                margin: 0 !important;
            }

            /* 설문지 인쇄: 1페이지 고정 */
            body:has(.print-container:not(.report-view)) {
                height: 297mm !important;
            }

            /* 리포트 인쇄: 다중 페이지 허용 */
            body:has(.report-view) {
                height: auto !important;
                display: block !important;
                width: 100% !important;
                /* @page margin 내에서 꽉 차게 */
                padding: 0 !important;
            }

            .print-container {
                box-shadow: none !important;
                border: 2pt solid #000 !important;
                width: 190mm !important;
                margin: 0 auto !important;
                padding: 0 !important;
                border-radius: 0 !important;
                background: white !important;
                display: flex;
                flex-direction: column;
                transform: translateY(10mm) !important;
                box-sizing: border-box !important;
            }

            /* 리포트 화면 전용 인쇄 스타일 (A4 2페이지 허용) */
            /* 리포트 화면 전용 인쇄 스타일 (A4 2페이지 허용) */
            /* print-container 속성을 완전히 덮어써서 리포트용으로 재설정 */
            .report-view.print-container {
                page: report-fmt !important;
                /* 위에서 정의한 페이지 여백 적용 */
                transform: none !important;
                /* border: none !으로 변경하여 테두리 제거 (영역만 유지) */
                border: none !important;
                width: 100% !important;
                /* 페이지 여백 제외한 영역 꽉 채움 (190mm 효과) */
                margin: 0 !important;
                /* @page가 여백 10mm를 담당하므로 추가 여백 없음 */
                padding: 0mm 5mm !important;
                /* 상하 패딩 제거하여 1,2페이지 동일 시작점 확보, 좌우만 유지 */
                box-sizing: border-box !important;
                min-height: auto !important;
                /* 최소 높이 확보 */

                /* [핵심] 페이지가 나뉠 때 테두리 복제 (각 페이지마다 테두리 그려짐) -> 테두리 없으므로 패딩 복제용 */
                -webkit-box-decoration-break: clone !important;
                box-decoration-break: clone !important;
            }

            /* [수정] 리포트 제목 상단 여백 제거 (1페이지 상단 여백을 @page 설정에만 의존하게 함) */
            .report-view h1 {
                margin-top: 0 !important;
                padding-top: 0 !important;
            }

            .report-view .border-b-4 {
                padding-top: 0 !important;
                margin-top: 0 !important;
            }

            .p-10 {
                padding: 0.5rem 1rem !important;
            }

            h1 {
                font-size: 16pt !important;
                margin-bottom: 0.05rem !important;
            }

            .text-sm {
                font-size: 7.5pt !important;
            }

            .text-xl {
                font-size: 10.5pt !important;
            }

            .p-10.space-y-12 {
                padding: 0.6rem 1.2rem !important;
            }

            .space-y-12>*+* {
                margin-top: 1.1rem !important;
            }

            h2 {
                font-size: 10.5pt !important;
                margin-bottom: 0 !important;
            }

            .mb-6,
            .mb-4 {
                margin-bottom: 0.3rem !important;
            }

            .w-1.5.h-6 {
                height: 1rem !important;
                width: 4px !important;
            }

            .info-grid {
                display: grid !important;
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 0.6rem !important;
            }

            .info-grid label {
                font-size: 8pt !important;
            }

            .info-grid select,
            .info-grid input {
                padding: 0.2rem 0.4rem !important;
                font-size: 8.5pt !important;
                height: 26px !important;
                border: 0.5pt solid #ccc !important;
            }

            .revenue-box {
                margin-top: 0.5rem !important;
                padding: 0.4rem 0.8rem !important;
                gap: 0.6rem !important;
                flex-wrap: nowrap !important;
                justify-content: space-between !important;
            }

            .revenue-box span {
                font-size: 7.5pt !important;
            }

            .revenue-box input {
                width: 70px !important;
                padding: 0.2rem 0.3rem !important;
                font-size: 7.5pt !important;
            }

            .revenue-box label {
                gap: 0.2rem !important;
            }

            .revenue-box input[type="radio"] {
                width: 12px !important;
                height: 12px !important;
            }

            .legend-box {
                padding: 0.2rem 0.5rem !important;
                margin-bottom: 0.25rem !important;
                border: 0.5pt solid #e2e8f0 !important;
                line-height: 0.85 !important;
                display: flex !important;
                flex-direction: column !important;
                gap: 0.05rem !important;
            }

            .legend-box span {
                font-size: 8pt !important;
            }

            .legend-box div.w-full {
                margin-bottom: 0 !important;
            }

            table th,
            table td {
                padding: 0.4rem 0.4rem !important;
                font-size: 9pt !important;
                border: 0.5pt solid #eee !important;
            }

            .text-center-print {
                text-align: center !important;
            }

            .w-9.h-9 {
                width: 1.2rem !important;
                height: 1.2rem !important;
                font-size: 8pt !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .bottom-grid {
                display: grid !important;
                grid-template-columns: 1.1fr 0.9fr !important;
                gap: 1.2rem !important;
                align-items: stretch !important;
            }

            .benefit-grid {
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                gap: 0.35rem !important;
                width: 100% !important;
            }

            .benefit-grid label {
                padding: 0.3rem 0.5rem !important;
                border: 0.5pt solid #eee !important;
                font-size: 8pt !important;
                height: 32px !important;
                display: flex !important;
                align-items: center;
                width: 100% !important;
                box-sizing: border-box !important;
                margin: 0 !important;
            }

            .notes-area {
                min-height: 132px !important;
                height: 100% !important;
                font-size: 9pt !important;
                padding: 0.5rem !important;
                border: 0.5pt solid #ccc !important;
                box-sizing: border-box !important;
            }

            /* --- [추가] 리포트 결과 화면 전용 스타일 --- */
            .report-view {
                display: block !important;
                box-shadow: none !important;
            }

            /* 기본정보 요약 그리드 (Compact) */
            .report-info-container {
                border: 1pt solid #ccc !important;
                background-color: #f8fafc !important;
                padding: 3mm !important;
                margin-bottom: 4mm !important;
                border-radius: 4px !important;
            }

            .report-info-grid {
                display: grid !important;
                grid-template-columns: repeat(4, 1fr) !important;
                gap: 2mm !important;
                row-gap: 2mm !important;
            }

            .report-info-item {
                display: flex !important;
                flex-direction: column !important;
            }

            .report-info-label {
                font-size: 7pt !important;
                color: #64748b !important;
                margin-bottom: 0 !important;
                font-weight: bold !important;
            }

            .report-info-value {
                font-size: 9pt !important;
                font-weight: 800 !important;
                color: #000 !important;
            }

            /* AI 텍스트 (A4 2페이지 분량) */
            .ai-text-line {
                font-size: 9.5pt !important;
                line-height: 1.5 !important;
                margin-bottom: 0.5mm !important;
                text-align: justify !important;
            }

            .ai-text-header {
                font-size: 10.5pt !important;
                font-weight: 900 !important;
                margin-top: 3mm !important;
                margin-bottom: 1.2mm !important;
                color: #000 !important;
                border-bottom: 0.5px dashed #bbb;
                display: block;
            }

            .ai-text-bold {
                font-weight: 800 !important;
            }
        }
    </style>
</head>

<body class="bg-slate-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const Icon = ({ name, size = 18, className = "" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        // ========== Google Sheets 지식 DB 설정 ==========
        // [종합지원] 시트: Sheet1(특별보증), Sheet2(정책자금), Sheet3(비금융 지원사업)
        // [참고자료] 시트: Sheet1(경기동향, 통계, 상권 자료 등)
        // 시트는 "공개" 또는 "링크가 있는 모든 사용자가 보기 가능"으로 설정되어야 합니다.
        // 형식: https://docs.google.com/spreadsheets/d/{SHEET_ID}/edit
        const KNOWLEDGE_SHEETS = {
            comprehensive: {
                sheetId: '', // [종합지원] 시트 ID 입력
                sheets: ['Sheet1', 'Sheet2', 'Sheet3'], // 특별보증, 정책자금, 비금융 지원사업
                description: '종합지원 (금융+비금융)'
            },
            reference: {
                sheetId: '', // [참고자료] 시트 ID 입력
                sheetName: 'Sheet1', // 경기동향, 통계, 상권 자료
                description: '참고자료 (경기동향·통계·상권)'
            }
        };

        // Google Sheets API v4를 사용하여 데이터 가져오기 (API Key 필요)
        const fetchSheetData = async (sheetId, sheetName, apiKey) => {
            if (!sheetId || !apiKey) return null;
            try {
                // Google Sheets API v4 endpoint
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${encodeURIComponent(sheetName)}?key=${apiKey}`;
                const response = await fetch(url);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || '시트를 불러올 수 없습니다.');
                }
                const data = await response.json();
                return parseSheetsData(data.values);
            } catch (error) {
                console.warn(`시트 로드 실패 (${sheetId}):`, error);
                return null;
            }
        };

        // Google Sheets API 응답을 객체 배열로 변환
        const parseSheetsData = (values) => {
            if (!values || values.length < 2) return [];

            const headers = values[0];
            const data = [];
            for (let i = 1; i < values.length; i++) {
                const row = {};
                headers.forEach((header, idx) => {
                    row[header] = values[i][idx] || '';
                });
                data.push(row);
            }
            return data;
        };

        // 지원사업 데이터를 프롬프트용 텍스트로 변환
        const formatKnowledgeForPrompt = (financialData, nonFinancialData, referenceData) => {
            let knowledgeText = '';

            if (financialData && financialData.length > 0) {
                // 특별보증과 정책자금 분리
                const guaranteeData = financialData.filter(row => row._구분 === '특별보증');
                const policyFundData = financialData.filter(row => row._구분 === '정책자금');

                knowledgeText += '\n\n[사전지식: 금융 지원사업 DB]\n';

                if (guaranteeData.length > 0) {
                    knowledgeText += '\n■ 특별보증 상품 (주요 추천 대상):\n';
                    knowledgeText += '아래 특별보증 중 자격이 충족되는 상품을 중심으로 안내하세요.\n';
                    guaranteeData.forEach((row, idx) => {
                        const values = Object.entries(row).filter(([k]) => k !== '_구분').map(([k, v]) => `${k}: ${v}`).join(' | ');
                        knowledgeText += `${idx + 1}. ${values}\n`;
                    });
                }

                if (policyFundData.length > 0) {
                    knowledgeText += '\n■ 정책자금 (보증상품 연계용):\n';
                    knowledgeText += '정책자금은 독립적으로 지원되지 않고 위 특별보증과 연계하여 취급됩니다. 특별보증 안내 시 연계 가능한 정책자금을 함께 언급하세요.\n';
                    policyFundData.forEach((row, idx) => {
                        const values = Object.entries(row).filter(([k]) => k !== '_구분').map(([k, v]) => `${k}: ${v}`).join(' | ');
                        knowledgeText += `${idx + 1}. ${values}\n`;
                    });
                }
            }

            if (nonFinancialData && nonFinancialData.length > 0) {
                knowledgeText += '\n\n[사전지식: 비금융 지원사업 DB]\n';
                knowledgeText += '아래는 현재 운영 중인 비금융 지원사업(컨설팅, 교육, 멘토링 등) 목록입니다. 고객의 니즈에 맞는 사업을 매칭할 때 이 정보를 최우선으로 참고하세요:\n';
                nonFinancialData.forEach((row, idx) => {
                    const values = Object.entries(row).map(([k, v]) => `${k}: ${v}`).join(' | ');
                    knowledgeText += `${idx + 1}. ${values}\n`;
                });
            }

            if (referenceData && referenceData.length > 0) {
                knowledgeText += '\n\n[사전지식: 참고자료 DB - 경기동향·통계·상권 분석]\n';
                knowledgeText += '아래 참고자료에서 사장님의 업종, 연령대, 업력, 신용점수, 매출 규모와 비교할 수 있는 통계 수치를 찾아 각 섹션(1~3, 5번)에서 반드시 인용하세요:\n';
                referenceData.forEach((row, idx) => {
                    const values = Object.entries(row).map(([k, v]) => `${k}: ${v}`).join(' | ');
                    knowledgeText += `${idx + 1}. ${values}\n`;
                });
            }

            if (knowledgeText) {
                knowledgeText += '\n[중요] 위 사전지식 DB에 있는 지원사업을 우선적으로 추천하고, 구체적인 사업명을 언급하세요. 참고자료 DB의 경기동향·통계 데이터는 진단 분석의 객관적 근거로 활용하세요. DB에 없는 일반적인 정보는 보조적으로만 활용하세요.\n';
            }

            return knowledgeText;
        };

        const App = () => {
            const currentYear = new Date().getFullYear();
            const years = Array.from({ length: 100 }, (_, i) => currentYear - i);

            const [apiKey, setApiKey] = useState(localStorage.getItem('gemini_api_key') || '');
            const [viewMode, setViewMode] = useState('form');
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [analysisStatus, setAnalysisStatus] = useState('');
            const [aiResponse, setAiResponse] = useState('');

            // Google Sheets 지식 DB 상태
            const [sheetConfig, setSheetConfig] = useState({
                comprehensiveSheetId: localStorage.getItem('comprehensive_sheet_id') || '',
                referenceSheetId: localStorage.getItem('reference_sheet_id') || ''
            });
            const [knowledgeData, setKnowledgeData] = useState({ financial: null, nonFinancial: null, reference: null });
            const [showSheetConfig, setShowSheetConfig] = useState(false);
            // 시트 유효성 검증 상태 (실제 로드 성공 여부) - localStorage에 저장하여 새로고침 시에도 유지
            const [sheetStatus, setSheetStatus] = useState(() => {
                try {
                    const saved = localStorage.getItem('sheet_status');
                    return saved ? JSON.parse(saved) : { comprehensive: false, reference: false };
                } catch { return { comprehensive: false, reference: false }; }
            });

            // 시트 설정 저장
            useEffect(() => {
                localStorage.setItem('comprehensive_sheet_id', sheetConfig.comprehensiveSheetId);
                localStorage.setItem('reference_sheet_id', sheetConfig.referenceSheetId);
            }, [sheetConfig]);

            // 시트 검증 상태 저장
            useEffect(() => {
                localStorage.setItem('sheet_status', JSON.stringify(sheetStatus));
            }, [sheetStatus]);

            useEffect(() => { localStorage.setItem('gemini_api_key', apiKey); }, [apiKey]);

            const [formData, setFormData] = useState({
                birthYear: '', niceScore: '', guaranteedAmount: '', foundationDate: '', sector: '', employeeCount: '', annualSales: '', revenueStatus: '', notes: '',
                benefits: { jobIncrease: false, jobCreation: false, intellectualProperty: false, socialInsurance: false, lowIncome: false, socialCare: false, smallBusiness: false, revenueDecrease: false },
                scores: Array(11).fill(0)
            });

            const categories = [{ name: "홍보·마케팅", startIdx: 0, count: 4 }, { name: "매장 운영·관리", startIdx: 4, count: 4 }, { name: "법률·노무·세무", startIdx: 8, count: 3 }];
            const questions = ["우리 동네 상권분석 데이터와 현재 트렌드가 궁금하다.", "쿠폰 발행, 이벤트 기획 등 구체적인 판촉 방법을 알고 싶다.", "인스타그램, 블로그 등 SNS 홍보를 잘하고 싶다.", "배달 앱이나 포털의 리뷰 및 평점 관리 방법을 배우고 싶다.", "고객 트렌드에 맞는 신메뉴나 신상품 개발을 도움받고 싶다.", "분위기 쇄신을 위한 매장 연출(VMD) 개선이 필요하다.", "우리 가게의 로고, 메뉴판 등 디자인을 개선하고 싶다.", "키오스크, 서빙로봇 등 디지털 기술 도입을 희망한다.", "임대료 인상이나 재계약 관련 법률 검토가 필요하다.", "직원 근로계약서, 주휴수당 등 노무 규정 도움이 필요하다.", "부가세, 소득세 신고 시 활용 가능한 절세 팁을 배우고 싶다."];

            // [원복] 통합버전18과 동일한 긴 텍스트 유지
            const benefitOptions = [
                { key: 'jobIncrease', label: '상시근로자 고용 증가' },
                { key: 'jobCreation', label: '일자리 창출(청년, 여성, 고령자, 장애인 고용)' },
                { key: 'intellectualProperty', label: '지식재산권(특허, 실용신안) 보유' },
                { key: 'socialInsurance', label: '사회보험 가입(1인 자영업자 고용보험 포함)' },
                { key: 'lowIncome', label: '저소득(연 59백만원 이하)' },
                { key: 'socialCare', label: '사회적배려(실직자, 장애인, 여성가장, 한부모·다둥이·다문화가정)' },
                { key: 'smallBusiness', label: '영세자영업(간이과세자)' },
                { key: 'revenueDecrease', label: '매출감소(직전 분기·반기 대비 신고매출액 20% 이상 감소)' }
            ];

            const handleScoreChange = (index, score) => { const newScores = [...formData.scores]; newScores[index] = score; setFormData({ ...formData, scores: newScores }); };
            const toggleBenefit = (key) => { setFormData({ ...formData, benefits: { ...formData.benefits, [key]: !formData.benefits[key] } }); };

            // [수정] 텍스트 포매터: 줄간격 최적화 + --- 구분선 제거
            const formatText = (text) => {
                if (!text) return "";
                // 빈 줄 및 --- 구분선 제거하여 세로 폭 절약
                return text.split('\n').filter(line => {
                    const trimmed = line.trim();
                    // 빈 줄, --- 구분선, *** 구분선 제거
                    if (trimmed === '' || trimmed.match(/^[-*=_]{3,}$/)) return false;
                    return true;
                }).map((line, i) => {
                    // 헤더 인식 (숫자로 시작하는 제목 또는 ## 등)
                    if (line.match(/^(##|#|\*\*?\s*[1-5]\.|[1-5]\.)/)) {
                        const cleanLine = line.replace(/^#+\s*/g, '').replace(/\*\*/g, '').trim();
                        return <div key={i} className="ai-text-header">{cleanLine}</div>;
                    }
                    // 본문
                    const parts = line.split(/(\*\*.*?\*\*)/g);
                    return (
                        <div key={i} className="ai-text-line">
                            {parts.map((part, j) => {
                                if (part.startsWith('**') && part.endsWith('**')) {
                                    return <strong key={j} className="ai-text-bold">{part.slice(2, -2)}</strong>;
                                }
                                return <span key={j}>{part}</span>;
                            })}
                        </div>
                    );
                });
            };

            const runRealAIAnalysis = async () => {
                if (!apiKey) { alert('상단 Safe Connect Mode에 구글 API 키를 먼저 입력해주세요.'); return; }

                setIsAnalyzing(true);
                setAnalysisStatus('지식 DB 로드 중...');

                // ========== Google Sheets 지식 DB 로드 ==========
                let financialData = null;
                let nonFinancialData = null;
                let referenceData = null;
                let newSheetStatus = { comprehensive: false, reference: false };

                if (sheetConfig.comprehensiveSheetId) {
                    setAnalysisStatus('종합지원 DB 로드 중 (Sheet1: 특별보증)...');
                    const sheet1Data = await fetchSheetData(sheetConfig.comprehensiveSheetId, 'Sheet1', apiKey);
                    console.log('종합지원 DB (Sheet1 - 특별보증):', sheet1Data);

                    setAnalysisStatus('종합지원 DB 로드 중 (Sheet2: 정책자금)...');
                    const sheet2Data = await fetchSheetData(sheetConfig.comprehensiveSheetId, 'Sheet2', apiKey);
                    console.log('종합지원 DB (Sheet2 - 정책자금):', sheet2Data);

                    setAnalysisStatus('종합지원 DB 로드 중 (Sheet3: 비금융 지원사업)...');
                    const sheet3Data = await fetchSheetData(sheetConfig.comprehensiveSheetId, 'Sheet3', apiKey);
                    console.log('종합지원 DB (Sheet3 - 비금융 지원사업):', sheet3Data);

                    // Sheet1과 Sheet2 데이터 병합 (금융)
                    if (sheet1Data || sheet2Data) {
                        financialData = [
                            ...(sheet1Data || []).map(row => ({ ...row, _구분: '특별보증' })),
                            ...(sheet2Data || []).map(row => ({ ...row, _구분: '정책자금' }))
                        ];
                        console.log('금융 지원사업 DB (통합):', financialData);
                    }

                    // Sheet3 데이터 (비금융)
                    if (sheet3Data) {
                        nonFinancialData = sheet3Data;
                    }

                    if (sheet1Data || sheet2Data || sheet3Data) {
                        newSheetStatus.comprehensive = true;
                    }
                }

                if (sheetConfig.referenceSheetId) {
                    setAnalysisStatus('참고자료 DB 로드 중 (경기동향·통계·상권)...');
                    referenceData = await fetchSheetData(sheetConfig.referenceSheetId, 'Sheet1', apiKey);
                    console.log('참고자료 DB:', referenceData);
                    if (referenceData) {
                        newSheetStatus.reference = true;
                    }
                }

                // 시트 상태 업데이트 (데이터가 실제로 있을 때만 true)
                newSheetStatus.comprehensive = !!(financialData || nonFinancialData);
                newSheetStatus.reference = !!(referenceData && referenceData.length > 0);

                setKnowledgeData({ financial: financialData, nonFinancial: nonFinancialData, reference: referenceData });
                setSheetStatus(newSheetStatus);

                // 지식 DB를 프롬프트용 텍스트로 변환
                const knowledgeText = formatKnowledgeForPrompt(financialData, nonFinancialData, referenceData);

                setAnalysisStatus('AI 서버에 연결 중...');

                const activeBenefits = Object.keys(formData.benefits).filter(k => formData.benefits[k]).map(k => benefitOptions.find(b => b.key === k).label).join(', ');


                // [수정된 프롬프트] 전문 컨설턴트 톤, 객관적/명확한 문어체 + 사전지식 DB 포함
                // 현재 날짜 정보 추가 (업력 계산용)
                const today = new Date();
                const todayStr = `${today.getFullYear()}년 ${today.getMonth() + 1}월 ${today.getDate()}일`;

                const promptText = `
당신은 서울신용보증재단의 경영컨설팅 전문가입니다. 
제공된 자가진단 데이터와 사장님의 주관식 의견을 바탕으로 전문적이고 정제된 '소상공인 경영 진단 리포트'를 작성하세요.

**[현재 날짜: ${todayStr}]** - 모든 업력/자격 요건 계산의 기준일입니다.
${knowledgeText}
[핵심 지침]
1. 말투: 지나치게 친근하거나 감성적인 호소는 배제합니다. 전문 컨설턴트로서 신뢰감을 주는 정중하고 명확한 문어체(~함, ~임, ~입니다)를 사용하세요.
2. 분석 우선순위: 섹션 3번 분석 시, 객관식 점수뿐만 아니라 '기타 애로사항(notes)'에 기재된 내용을 최우선으로 반영하여 분석하세요. 사장님의 직접적인 목소리가 가장 시급한 현안입니다.
3. 데이터 해석: 1~4점의 점수를 직접 언급하지 마세요. 대신 "개선 의지가 강한", "전문적 지원이 필요한", "현안 해결이 우선시되는" 등의 표현을 사용합니다. 이 숫자는 점수가 아닙니다. 합계 등 의미가 없습니다. 1에서 4로 갈수록 더 지원이 필요하다고 느낀다는 의미일 뿐입니다.
4. 서식: 섹션 제목은 반드시 "1. 기본정보 분석", "2. 사업 생애주기 진단" 이런 식으로 숫자와 점으로만 시작하세요. ##이나 **를 사용하지 마세요.
5. **사전지식 DB 활용**: 위에 제공된 [사전지식: 금융/비금융 지원사업 DB]가 있다면, 섹션 4번 작성 시 해당 DB의 구체적인 사업명과 내용을 최우선으로 인용하세요.
6. **참고자료 활용 - 필수**: [사전지식: 참고자료 DB]가 제공되었다면, 해당 DB의 내용을 **최우선으로 인용**하세요.
   - 단, DB에 없는 최신 데이터나 보충 설명이 필요한 경우에는 **외부 검색이나 일반적인 통계 지식을 보조적으로 활용**해도 좋습니다.
   - 각 섹션에서 반드시 1회 이상 참고자료(DB 또는 외부지식)의 구체적 수치를 인용하여 사장님의 상황을 객관화하세요.
  - **섹션 1(기본정보)**: 참고자료에서 해당 업종의 평균 대출액, 매출액, 대표자 연령대별 매출액 대비 대출 비중 등을 찾아 사장님의 수치와 비교하세요. (예: "동일 업종 소상공인의 업체당 평균 매출액은 X만원으로, 사장님의 매출 규모는 이보다 다소 낮은/높은 편입니다", "사장님 연령대(X0대)의 매출액 대비 대출 비중은 평균 X%로...")
  - **섹션 2(생애주기)**: 참고자료에서 업력별 부채 특성, 창업 초기 vs 장기 사업자 특성을 찾아 사장님의 업력과 비교하세요. (예: "업력 X년 이상 장기 사업자의 매출액 대비 대출액 비중은 X%로 가장 높은 점을 감안하면...", "창업 초기(4년 미만)의 제2금융권 의존도가 X%인 점과 비교할 때...")
  - **섹션 3(지원필요분야)**: 참고자료에서 해당 업종의 매출 증감률, 경기동향, 고금리채무자 증가율 등을 찾아 사장님의 어려움이 개인적 문제인지 업종 전반의 추세인지 맥락을 제공하세요. (예: "최근 숙박·음식점업의 매출 증가율이 -2.0%로 감소 추세인 점과 맥을 같이 합니다", "해당 업종의 고금리채무자 수가 전년 대비 X% 폭증한 상황에서...")
  - **섹션 5(종합정리)**: 참고자료의 취약차주 동향(다중채무, 풍선효과 등)이나 정책 제언을 근거로 리스크 관리 및 향후 대응 전략을 제시하세요.
  - **[각주 표시 규칙 - 엄수]**: 
    1. 본문에서 통계 수치를 인용할 때는 반드시 문장 끝에 [1], [2]와 같이 번호만 매기세요.
    2. 리포트 제일 마지막에 한 줄 띄우고 "참고자료: [1] 자료명(00년), [2] 자료명..." 형태로 작성하세요.
    3. **주의**: [사전지식: 참고자료 DB]가 제공되지 않았다면, 이 각주 섹션을 아예 작성하지 마세요. (빈 내용으로 두세요)
   - **주의**: "참고자료에 따르면", "DB상" 같은 메타 표현 없이, 마치 전문가가 시장 데이터를 숙지한 상태에서 자연스럽게 이야기하듯 써야 합니다.
   - **(가상) 표기 절대 금지**: 참고자료 DB가 주어지지 않았다면, 차라리 출처를 표시하지 마세요. "2024년 소상공인 실태조사 (가상)"과 같이 **지어낸 자료명(가상, 임의 등)을 사용하는 것은 치명적인 오류**입니다. 실존하는 자료가 아니면 인용하지 마세요.
   - **인용 규칙**: 상단에 [사전지식: 참고자료 DB]가 **있는 경우에만** [1], [2] 각주를 사용하세요. DB가 없다면 각주 없이 전문가의 통찰력으로만 작성하세요.

[⚠️ 자격 요건 필터링 - 반드시 준수]
1. **업력(설립일) 검증 필수**: 현재 날짜(${todayStr})와 설립일을 비교하여 정확한 업력(개월/년)을 먼저 계산하세요. 지원사업의 업력 기준(예: "창업 1년 이내", "업력 3개월 이상 3년 이하" 등)에 부합하지 않는 상품은 **절대 언급하지 마세요.**
2. **가정법 사용 금지**: "~라면 가능합니다", "조건이 맞는다면", "교육을 이수했다면" 등 불확실한 가정형 문장을 배제하세요. 현재 입력된 데이터로 자격이 **확실히 충족되는** 상품만 매칭하세요.
3. **부적격 상품 즉시 제외**: 업력, NICE점수, 매출액, 기보증금액 등 어느 하나라도 지원 기준에 미달하면 해당 상품은 추천 대상에서 제외하세요. "아쉽지만 자격이 안 됩니다" 같은 언급도 하지 마세요 - 그냥 언급 자체를 하지 마세요.
4. **우선순위 매칭**: 자격이 충족되는 상품이 여러 개라면, 보증료율이 낮거나 한도가 큰 상품을 우선 추천하세요.

[필수 금지 사항]
1. 리포트 제목, 인사말, 날짜, 서명 등 불필요한 서두와 결미를 생략하고 바로 본론으로 들어갑니다.
2. 구분선(---)이나 불필요한 빈 줄을 사용하지 마세요. (공간 최적화)
3. **글자수 절대 준수**: 전체 분량은 공백 포함 **3,000자 내외**로 작성하세요. (2,800자 ~ 3,200자 사이) 
   - 정보가 희석되지 않도록 핵심만 간결하게 전달하는 것이 생명입니다. 불필요한 서술어를 줄이세요.
4. **메타 표현 금지**: "제공된 DB 내에서는", "사전지식 DB에 따르면", "데이터베이스 상으로는" 등 내부 데이터 참조를 암시하는 메타 표현을 사용하지 마세요. 전문가가 시장 데이터를 이미 숙지한 상태에서 자연스럽게 분석하듯이 작성하세요.

[리포트 구성 및 작성 요령]

1. 기본정보 분석 (500자)
- 업종, 출생년도, 신용점수, 기보증금액, 신고매출액 등을 바탕으로 사업자의 객관적인 경영 여력을 분석합니다.
- **중요**: 기보증금액은 이미 재단의 보증 한도를 사용하고 있다는 의미입니다. 신고매출액 대비 기보증금액이 높을수록 추가 보증 여력이 제한됩니다(매출액 이상은 추가 보증 불가). 이 비율을 감안하여 추가 자금 조달의 가능성을 전문가적 시각에서 평가하세요.
- **참고자료 활용**: 해당 업종의 업체당 평균 매출액·대출액, 대표자 연령대별 매출 대비 대출 비중, 신용등급 분포 등과 사장님의 수치를 비교하여 상대적 위치를 진단하세요. [1]

2. 사업 생애주기 진단 (500자)
- 현재 날짜(${todayStr})와 설립일을 비교하여 정확한 업력(년/개월)을 먼저 계산하세요.
- 설립일과 매출 추이를 근거로 현재 사업의 단계(창업기-성장기-성숙기-재도약기)를 정의합니다. 현재 매출 상태가 해당 생애주기에서 갖는 의미를 짚어주세요.
- **참고자료 활용**: 업력별 부채 특성(창업 초기 vs 장기 사업자), 제2금융권 의존도, 다중채무자 비중 등과 비교하여 사장님의 현재 단계가 통계적으로 어떤 의미인지 해석하세요. [2]

3. 중점 지원 필요분야 분석 (700자)
- 자가진단 고득점 항목과 '기타 애로사항'의 주관식 내용을 통합 분석합니다. 단순히 어떤 지원이 필요하다는 식으로 나열하지 마세요.
- 사장님이 겪고 있는 경영적 한계의 본질이 무엇인지 진단하세요. (예: "주관식 의견에 기술된 임대료 부담과 매출 정체는 단순 마케팅 문제가 아닌 수익 구조의 근본적 체질 개선이 필요한 신호임")
- **참고자료 활용**: 해당 업종의 매출 증감률, 고금리채무자 증가율, 경기동향 등과 연결하여 사장님의 어려움이 개인적 문제인지 업종 전반의 구조적 추세인지 맥락을 제공하세요. [3]

4. 맞춤형 지원사업 매칭 (700자)
- **[매칭 전 필수 검증]**: 각 지원사업의 자격 요건을 사장님의 실제 데이터와 대조하세요. 자격이 100% 충족되는 사업만 추천하세요.
- 매칭된 상품의 핵심 특징(보증료율, 상환조건 등)을 간결하면서도 구체적으로 안내하세요.
- **정책자금 금액 언급 금지**: 정책자금은 특별보증에 종속되는 개념이므로, 정책자금의 구체적 한도금액이나 조달 가능 금액을 언급하지 마세요. 보증 금액도 심사 결과에 따라 달라지므로 구체적 금액을 단정적으로 제시하지 마세요.
- 1. 2. 3. 번호 매기기, 구분선(---), 볼드체(**) 사용을 금지합니다. 자연스러운 문장으로 이어서 작성하세요.
- [금융]: 특별보증 상품을 중심으로 안내하고, 연계 가능한 정책자금명을 함께 언급하세요.
- [비금융]: 3번 항목에서 도출된 문제를 해결할 수 있는 비금융 지원사업을 구체적으로 연결하세요.
- 형식 **절대 준수**: "[금융] 내용이 바로 이어집니다..." 형태로, [금융] 접두어 바로 뒤에 공백 하나만 두고 내용을 시작하세요. 절대 줄바꿈하지 마세요. [비금융]도 마찬가지입니다. [금융] 문단과 [비금융] 문단 사이에만 줄바꿈 1회 허용합니다.
- **잘못된 예**: "[금융]\n서울형 중·저신용자..." (줄바꿈 있음 - 절대 금지)
- **올바른 예**: "[금융] 서울형 중·저신용자..." (같은 줄에 이어짐)
- **주의**: 줄바꿈을 하면 시스템에서 오류로 처리됩니다. 반드시 한 줄로 이어서 쓰세요.

5. 종합 정리 (600자)
- 전체 진단을 종합하여 경영 효율화 및 리스크 관리를 위한 핵심 제언을 기술하세요. 감성적 위로보다는 전문가로서의 실천적 대안(One-Point Lesson)을 제시하며 마무리합니다.
- **참고자료 활용**: 취약차주 동향(다중채무 증가, 제2금융권 풍선효과 등)이나 정책 제언을 근거로 사장님이 주의해야 할 리스크와 대응 전략을 제시하세요. [4]

[참고자료 출처 작성란]
- 리포트 맨 마지막에 반드시 아래 형식으로 출처를 남기세요.
- 형식: "참고자료: [1] 자료명, [2] 자료명..."



[상담 데이터]
- 업종: ${formData.sector} / 설립일: ${formData.foundationDate}
- NICE: ${formData.niceScore}점 / 기보증: ${formData.guaranteedAmount}만원 / 최근1년 신고매출액: ${formData.annualSales || '미입력'}만원 / 매출추이: ${formData.revenueStatus}
- 우대사항: ${activeBenefits}
- 자가진단 니즈 점수(11개 항목): ${JSON.stringify(formData.scores)}
- 기타 애로사항(중요): ${formData.notes || '내용 없음'}
`;

                try {
                    const listResp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                    const listData = await listResp.json();
                    if (listData.error) throw new Error(listData.error.message);

                    // 모델 목록에서 최적 모델 찾기
                    const generativeModels = listData.models.filter(m => m.supportedGenerationMethods.includes('generateContent') && !m.name.includes('embedding') && !m.name.includes('aqa'));
                    const bestModel = generativeModels.find(m => m.name.includes('gemini-1.5-flash')) || generativeModels[0];

                    setAnalysisStatus(`${bestModel.name.split('/')[1]} 모델이 리포트 작성 중...`);

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/${bestModel.name}:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: promptText }] }] })
                    });

                    const data = await response.json();
                    console.log('API 응답:', data); // 디버깅용
                    console.log('사용된 프롬프트 (지식DB 포함):', promptText); // 디버깅용
                    if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                        setAiResponse(data.candidates[0].content.parts[0].text);
                        setViewMode('report');
                        window.scrollTo(0, 0);
                    } else {
                        console.error('응답 오류:', data);
                        throw new Error(`분석 결과가 비어있습니다. 상세: ${JSON.stringify(data.error || data.promptFeedback || '알 수 없음')}`);
                    }
                } catch (error) { alert(`오류 발생: ${error.message}`); }
                finally { setIsAnalyzing(false); setAnalysisStatus(''); }
            };

            const ReportView = () => (
                <div className="max-w-4xl mx-auto my-8 print:m-0 print:p-0 animate-in fade-in slide-in-from-bottom-4 duration-700">
                    <div className="bg-white p-12 print:p-0 shadow-xl border border-slate-200 rounded-sm print-container report-view">
                        <div className="border-b-4 border-slate-900 pb-4 mb-6">
                            <h1 className="text-3xl font-black text-slate-900 tracking-tight">소상공인 종합지원 AI 진단 리포트</h1>
                            <p className="text-sm text-slate-500 font-bold mt-2">AI-Powered Analysis by Seoul Credit Guarantee Foundation</p>
                            {!sheetStatus.reference && <p className="text-xs text-red-500 font-bold mt-1 no-print">⚠️ 참고자료 DB가 로드되지 않았습니다. (설정 확인 필요)</p>}
                            {sheetStatus.reference && <p className="text-xs text-blue-500 font-bold mt-1 no-print">✅ 참고자료 DB 로드됨 ({knowledgeData.reference ? knowledgeData.reference.length : 0}건)</p>}
                        </div>

                        {/* [수정] 칭찬해주신 '기본정보 요약 그리드' 적용 */}
                        <div className="mb-6 report-info-container bg-slate-50 rounded-lg border border-slate-200 p-4">
                            <h3 className="text-xs font-bold text-slate-400 uppercase mb-3 tracking-wider border-b border-slate-200 pb-1">기본정보 요약</h3>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 report-info-grid">
                                <div className="report-info-item"><span className="text-xs text-slate-500 block report-info-label">업종</span><span className="text-sm font-black text-slate-800 report-info-value">{formData.sector || "-"}</span></div>
                                <div className="report-info-item"><span className="text-xs text-slate-500 block report-info-label">출생년도</span><span className="text-sm font-black text-slate-800 report-info-value">{formData.birthYear || "-"}년</span></div>
                                <div className="report-info-item"><span className="text-xs text-slate-500 block report-info-label">NICE 점수</span><span className="text-sm font-black text-slate-800 report-info-value">{formData.niceScore || "0"}점</span></div>
                                <div className="report-info-item"><span className="text-xs text-slate-500 block report-info-label">기보증금액</span><span className="text-sm font-black text-slate-800 report-info-value">{formData.guaranteedAmount || "0"}만원</span></div>
                                <div className="report-info-item"><span className="text-xs text-slate-500 block report-info-label">설립일자</span><span className="text-sm font-black text-slate-800 report-info-value">{formData.foundationDate || "-"}</span></div>
                                <div className="report-info-item"><span className="text-xs text-slate-500 block report-info-label">종업원수</span><span className="text-sm font-black text-slate-800 report-info-value">{formData.employeeCount || "0"}명</span></div>
                                <div className="report-info-item col-span-2"><span className="text-xs text-slate-500 block report-info-label">매출현황</span><span className="text-sm font-black text-slate-800 report-info-value">{formData.annualSales || "-"}만원({formData.revenueStatus || "-"})</span></div>
                            </div>
                        </div>

                        {/* [수정] 줄간격 축소된 AI 본문 + [금융]/[비금융] 줄바꿈 강제 제거 후처리 */}
                        <div className="space-y-4 text-slate-700 leading-relaxed text-sm md:text-base">
                            {formatText(aiResponse
                                .replace(/([^\n])\s*\[비금융\]/g, '$1\n\n[비금융]') // [비금융] 앞에는 반드시 줄바꿈 2번
                                .replace(/(\[(?:금융|비금융)\])[:\s]*[\r\n]+\s*/g, '$1 ') // [금융]/[비금융] 뒤에는 줄바꿈 제거하고 공백 1개
                            )}
                        </div>

                        <div className="mt-8 pt-6 border-t flex justify-center gap-4 no-print">
                            <button onClick={() => setViewMode('form')} className="px-8 py-3 bg-slate-800 text-white rounded-full font-black hover:bg-slate-700 flex items-center gap-2"><Icon name="rotate-ccw" size={18} /> 다시 진단하기</button>
                            <button onClick={() => window.print()} className="px-8 py-3 border-2 border-slate-800 text-slate-800 rounded-full font-black hover:bg-slate-50 transition-all">
                                리포트 인쇄
                            </button>
                        </div>
                    </div>
                </div>
            );

            if (viewMode === 'report') return <div className="min-h-screen py-8 px-4 bg-slate-100 print:p-0 print:m-0 print:bg-white"><ReportView /></div>;

            return (
                <div className="min-h-screen py-8 px-4 relative">
                    <div className="max-w-5xl mx-auto mb-4 no-print flex justify-end items-center gap-2">
                        {/* 지식 DB 설정 버튼 */}
                        <button
                            onClick={() => setShowSheetConfig(!showSheetConfig)}
                            className={`text-xs px-3 py-1.5 rounded-full flex items-center gap-2 shadow-lg transition-all ${showSheetConfig ? 'bg-amber-500 text-white' : 'bg-slate-700 text-white hover:bg-slate-600'}`}
                        >
                            <Icon name="database" size={14} className={showSheetConfig ? 'text-white' : 'text-amber-400'} />
                            <span className="font-bold">지식 DB</span>
                            {(sheetStatus.comprehensive || sheetStatus.reference) &&
                                <span className="bg-emerald-500 text-white text-[10px] px-1.5 py-0.5 rounded-full font-bold">ON</span>
                            }
                            {(sheetConfig.comprehensiveSheetId || sheetConfig.referenceSheetId) && !(sheetStatus.comprehensive || sheetStatus.reference) &&
                                <span className="bg-amber-500 text-white text-[10px] px-1.5 py-0.5 rounded-full font-bold">미검증</span>
                            }
                        </button>

                        <div className="bg-slate-800 text-white text-xs px-3 py-1.5 rounded-full flex items-center gap-2 shadow-lg">
                            <Icon name="shield-check" size={14} className="text-emerald-400" />
                            <span className="font-bold">Safe Connect Mode</span>
                            <div className="w-[1px] h-3 bg-slate-600 mx-1"></div>
                            <input
                                type="password" placeholder="Google API Key 입력"
                                className="bg-transparent border-none outline-none text-white placeholder-slate-400 w-32 focus:w-64 transition-all"
                                value={apiKey} onChange={(e) => setApiKey(e.target.value)}
                            />
                        </div>
                    </div>

                    {/* 지식 DB 설정 패널 (토글) */}
                    {showSheetConfig && (
                        <div className="max-w-5xl mx-auto mb-4 no-print bg-slate-800 text-white rounded-lg p-4 shadow-xl border border-slate-700">
                            <div className="flex items-center gap-2 mb-3 pb-2 border-b border-slate-600">
                                <Icon name="book-open" size={16} className="text-amber-400" />
                                <span className="font-black text-sm">Google Sheets 지식 DB 설정</span>
                                <span className="text-xs text-slate-400 ml-2">(동일한 Google API Key 사용)</span>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className="space-y-1">
                                    <label className="text-xs font-bold text-amber-300">종합지원 시트 ID</label>
                                    <input
                                        type="text"
                                        placeholder="예: 1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms"
                                        className="w-full p-2 bg-slate-700 border border-slate-600 rounded text-sm text-white placeholder-slate-500 outline-none focus:border-amber-400"
                                        value={sheetConfig.comprehensiveSheetId}
                                        onChange={(e) => setSheetConfig({ ...sheetConfig, comprehensiveSheetId: e.target.value })}
                                    />
                                    <p className="text-[10px] text-slate-400">Sheet1: 특별보증 | Sheet2: 정책자금 | Sheet3: 비금융 지원사업</p>
                                </div>
                                <div className="space-y-1">
                                    <label className="text-xs font-bold text-emerald-300">참고자료 시트 ID</label>
                                    <input
                                        type="text"
                                        placeholder="예: 1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms"
                                        className="w-full p-2 bg-slate-700 border border-slate-600 rounded text-sm text-white placeholder-slate-500 outline-none focus:border-emerald-400"
                                        value={sheetConfig.referenceSheetId}
                                        onChange={(e) => setSheetConfig({ ...sheetConfig, referenceSheetId: e.target.value })}
                                    />
                                    <p className="text-[10px] text-slate-400">경기동향, 각종 통계, 상권 자료 등 진단 참고자료</p>
                                </div>
                            </div>
                            <div className="mt-3 pt-2 border-t border-slate-600 text-xs text-slate-400">
                                <p>💡 <b className="text-white">사용 방법:</b> Google Cloud Console에서 Sheets API를 활성화하고, 시트를 API Key로 접근 가능하게 설정하세요.</p>
                            </div>
                        </div>
                    )}

                    <div className="max-w-5xl mx-auto bg-white shadow-2xl border border-slate-200 overflow-hidden print-container rounded-sm">
                        <div className="p-10 border-b border-slate-100 bg-white relative">
                            <div className="flex justify-between items-start">
                                <div>
                                    <div className="flex items-center gap-2 mb-2">
                                        <span className="text-xs font-bold text-slate-400 tracking-tighter uppercase italic">Seoul Credit Guarantee Foundation</span>
                                    </div>
                                    <h1 className="text-4xl font-black text-slate-900 tracking-tight leading-none mb-2">소상공인 종합지원을 위한 자가진단</h1>
                                    <p className="text-sm text-slate-500 font-medium">우리 가게 맞춤형 지원사업 매칭을 위한 기초 리포트</p>
                                </div>
                                <div className="text-right"><p className="text-xl font-black text-[#0055A5] leading-tight mb-1">내일을 꿈꾸는 사장님께</p><p className="text-sm font-bold text-slate-400">서울신용보증재단 용산종합지원센터</p></div>
                            </div>
                        </div>

                        <div className="p-10 space-y-12">
                            {/* [중요] 기존 통합버전18의 입력폼 코드 100% 동일하게 유지 (인쇄 레이아웃 포함) */}
                            <section>
                                <div className="flex items-center gap-2 mb-4"><div className="w-1.5 h-6 bg-[#0055A5]"></div><h2 className="text-xl font-black text-slate-800 uppercase tracking-tight">1. 기본정보(대표자, 사업체)</h2></div>
                                <div className="info-grid grid grid-cols-1 md:grid-cols-3 gap-y-5 gap-x-8">
                                    <div className="space-y-1.5"><label className="text-sm font-black text-slate-500 ml-1">출생년도</label><select className="w-full p-3 bg-slate-50 border border-slate-200 rounded-sm outline-none text-base font-bold" value={formData.birthYear} onChange={(e) => setFormData({ ...formData, birthYear: e.target.value })}><option value="">년도 선택</option>{years.map(y => <option key={y} value={y}>{y}년</option>)}</select></div>
                                    <div className="space-y-1.5"><label className="text-sm font-black text-slate-500 ml-1">NICE CB점수</label><input type="number" placeholder="점수 입력" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-sm outline-none text-base font-bold" value={formData.niceScore} onChange={(e) => setFormData({ ...formData, niceScore: e.target.value })} /></div>
                                    <div className="space-y-1.5"><label className="text-sm font-black text-slate-500 ml-1">기보증금액 (만원)</label><input type="number" placeholder="금액 입력" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-sm outline-none text-base font-bold" value={formData.guaranteedAmount} onChange={(e) => setFormData({ ...formData, guaranteedAmount: e.target.value })} /></div>
                                    <div className="space-y-1.5"><label className="text-sm font-black text-slate-500 ml-1">설립일자</label><input type="date" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-sm outline-none text-base font-bold" value={formData.foundationDate} onChange={(e) => setFormData({ ...formData, foundationDate: e.target.value })} /></div>
                                    <div className="space-y-1.5"><label className="text-sm font-black text-slate-500 ml-1">업종</label><input type="text" placeholder="업종 입력" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-sm outline-none text-base font-bold" value={formData.sector} onChange={(e) => setFormData({ ...formData, sector: e.target.value })} /></div>
                                    <div className="space-y-1.5"><label className="text-sm font-black text-slate-500 ml-1">종업원수 (명)</label><input type="number" placeholder="인원 수" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-sm outline-none text-base font-bold" value={formData.employeeCount} onChange={(e) => setFormData({ ...formData, employeeCount: e.target.value })} /></div>
                                </div>
                                <div className="revenue-box mt-8 flex flex-wrap items-center gap-10 p-5 bg-slate-50 rounded-sm border border-slate-100">
                                    <div className="flex items-center gap-4">
                                        <span className="text-sm font-black text-slate-500 uppercase tracking-tighter">매출현황 :</span>
                                        <div className="flex items-center gap-2">
                                            <input type="number" placeholder="신고매출액 입력" className="w-40 p-2.5 bg-white border border-slate-200 rounded-sm outline-none text-base font-bold text-right focus:ring-1 focus:ring-[#0055A5]" value={formData.annualSales} onChange={(e) => setFormData({ ...formData, annualSales: e.target.value })} />
                                            <span className="text-xs font-bold text-slate-500">만원/년</span>
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-5">
                                        {["지속적인 감소", "감소 후 정체", "현상유지", "증가 후 정체", "지속적인 증가"].map((opt) => (
                                            <label key={opt} className="flex items-center gap-2 cursor-pointer group"><input type="radio" name="revenue" className="w-4 h-4 accent-[#0055A5]" checked={formData.revenueStatus === opt} onChange={() => setFormData({ ...formData, revenueStatus: opt })} /><span className={`text-sm font-bold ${formData.revenueStatus === opt ? 'text-[#0055A5]' : 'text-slate-500'}`}>{opt}</span></label>
                                        ))}
                                    </div>
                                </div>
                            </section>

                            <section>
                                <div className="flex items-center gap-2 mb-4"><div className="w-1.5 h-6 bg-[#0055A5]"></div><h2 className="text-xl font-black text-slate-800 uppercase tracking-tight">2. 사업운영 주요 현황</h2></div>
                                <div className="legend-box mb-5 flex flex-wrap gap-5 bg-blue-50/50 p-4 border border-blue-100/50 rounded-sm shadow-sm"><div className="w-full no-print-bg"><span className="text-xs font-black text-[#0055A5] uppercase tracking-widest underline decoration-blue-200 underline-offset-4">진단 지표 척도 안내 (1~4점)</span></div><div className="flex gap-6"><span className="text-sm font-bold text-slate-700"><b className="text-[#0055A5]">1:</b> 전혀 그렇지 않다</span><span className="text-sm font-bold text-slate-700"><b className="text-[#0055A5]">2:</b> 그렇지 않다</span><span className="text-sm font-bold text-slate-700"><b className="text-[#0055A5]">3:</b> 그렇다</span><span className="text-sm font-bold text-slate-700"><b className="text-[#0055A5]">4:</b> 매우 그렇다</span></div></div>
                                <div className="overflow-x-auto border-t-2 border-slate-800">
                                    <table className="w-full border-collapse">
                                        <thead><tr className="bg-slate-50 text-xs font-black text-slate-500 border-b border-slate-200"><th className="p-4 text-center w-28 text-center-print">구분</th><th className="p-4 text-center text-center-print">진단문항</th> {[1, 2, 3, 4].map(n => <th key={n} className="p-4 text-center w-16">{n}</th>)}</tr></thead>
                                        <tbody>
                                            {categories.map((cat) => (
                                                <React.Fragment key={cat.name}>
                                                    {questions.slice(cat.startIdx, cat.startIdx + cat.count).map((q, qIdx) => (
                                                        <tr key={q} className="border-b border-slate-100 hover:bg-slate-50/30 transition-colors">
                                                            {qIdx === 0 && (<td rowSpan={cat.count} className="p-4 align-middle font-black text-sm text-[#0055A5] border-r border-slate-100 bg-slate-50/20 text-center text-center-print whitespace-pre-wrap">{cat.name === "매장 운영·관리" ? <span>매장 운영·<br className="screen-only" />관리</span> : cat.name === "법률·노무·세무" ? <span>법률·노무·<br className="screen-only" />세무</span> : cat.name}</td>)}
                                                            <td className="p-4 text-base text-slate-700 font-medium leading-snug text-center-print">{q}</td>
                                                            {[1, 2, 3, 4].map(score => (<td key={score} className="p-4 text-center"><button onClick={() => handleScoreChange(cat.startIdx + qIdx, score)} className={`w-9 h-9 rounded-sm border transition-all text-sm font-black ${formData.scores[cat.startIdx + qIdx] === score ? 'bg-[#0055A5] border-[#0055A5] text-white shadow-md' : 'bg-white border-slate-200 text-slate-300 hover:border-slate-400 hover:text-slate-500'}`}>{score}</button></td>))}
                                                        </tr>
                                                    ))}
                                                </React.Fragment>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </section>

                            <div className="bottom-grid grid grid-cols-1 md:grid-cols-2 gap-10 items-stretch">
                                <section className="flex flex-col"><div className="flex items-center gap-2 mb-4"><div className="w-1.5 h-6 bg-[#0055A5]"></div><h2 className="text-xl font-black text-slate-800 uppercase tracking-tight">3. 우대사항 체크</h2></div><div className="benefit-grid space-y-1.5">{benefitOptions.map(item => (<label key={item.key} className={`flex items-start gap-3 px-4 py-2.5 rounded-sm border transition-all cursor-pointer group ${formData.benefits[item.key] ? 'bg-blue-50 border-blue-200' : 'bg-white border-slate-100 hover:bg-slate-50'}`}><input type="checkbox" className="mt-0.5 w-5 h-5 accent-[#0055A5]" checked={formData.benefits[item.key]} onChange={() => toggleBenefit(item.key)} /><span className="text-sm font-bold leading-tight group-hover:text-slate-900 transition-colors"><span className={`${formData.benefits[item.key] ? 'text-[#0055A5]' : 'text-slate-600'} screen-only`}>{item.label}</span><span className={`${formData.benefits[item.key] ? 'text-[#0055A5]' : 'text-slate-600'} print-only`}>{item.label.split('(')[0].trim()}</span></span></label>))}</div></section>
                                <section className="flex flex-col"><div className="flex items-center gap-2 mb-4"><div className="w-1.5 h-6 bg-[#0055A5]"></div><h2 className="text-xl font-black text-slate-800 uppercase tracking-tight">※ 기타 애로사항</h2></div><textarea className="notes-area w-full flex-grow p-5 border border-slate-200 rounded-sm text-base bg-slate-50/50 focus:ring-1 focus:ring-[#0055A5] outline-none resize-none font-medium leading-relaxed placeholder:text-slate-300" placeholder="구체적인 고민이나 지원이 시급한 내용을 자유롭게 기록하세요." value={formData.notes} onChange={(e) => setFormData({ ...formData, notes: e.target.value })} /></section>
                            </div>

                            <div className="flex justify-between items-center pt-10 border-t border-slate-200 no-print">
                                <button onClick={() => setFormData({ ...formData, scores: Array(11).fill(0), notes: '', benefits: Object.fromEntries(Object.keys(formData.benefits).map(k => [k, false])) })} className="flex items-center gap-2 text-slate-400 hover:text-red-500 font-black text-sm transition-colors"><Icon name="rotate-ccw" size={16} /> 리셋하기</button>
                                <div className="flex gap-4">
                                    <button onClick={runRealAIAnalysis} disabled={isAnalyzing} className={`flex items-center gap-3 px-8 py-4 bg-emerald-600 text-white rounded-sm font-black shadow-xl hover:bg-emerald-700 transition-all text-lg ${isAnalyzing ? 'opacity-50' : ''}`}><Icon name={isAnalyzing ? "loader-2" : "sparkles"} size={22} className={isAnalyzing ? "animate-spin" : ""} />{isAnalyzing ? analysisStatus : "AI 진단 시작"}</button>
                                    <button onClick={() => window.print()} className="flex items-center gap-3 px-10 py-4 bg-[#0055A5] text-white rounded-sm font-black shadow-xl hover:bg-[#004488] transition-all transform active:scale-95 text-lg"><Icon name="printer" size={22} /> 설문지 인쇄</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>


</html>